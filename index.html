<!DOCTYPE html>
<html lang="en">

<head>
	<meta charset="UTF-8" />
	<meta name="viewport" content="width=device-width, initial-scale=1.0" />
	<title>Prayer Times App</title>
	<style>
		body {
			margin: 0;
			font-family: 'Segoe UI', sans-serif;
			background: none;
			padding: 35px;
			font-size: 18px;
			color: white;
			position: relative;
			overflow-x: hidden;
		}

		body::before {
			content: "";
			position: fixed;
			top: 0;
			left: 0;
			width: 100%;
			height: 100%;
			background-image: url('background.jpg');
			background-size: cover;
			background-position: center;
			filter: blur(18px) brightness(0.7);
			/* blur + darken */
			z-index: -1;
		}


		.container {
			max-width: 800px;
			margin: auto;
		}

		.date-box {
			display: flex;
			justify-content: center;
			align-items: center;
			gap: 10px;
			margin-bottom: 10px;
			font-size: 20px;
			font-weight: bold;
			background-color: brown;
			border-radius: 10px;
			box-shadow: 0px 0px 22px 0px black;
			height: 50px;
		}

		.location {
			display: flex;
			justify-content: space-between;
			align-items: center;
			margin: 10px 0;
			font-size: 16px;
		}

		h3 {
			margin: 0;
		}

		.card {
			background: #0b3c33;
			padding: 20px;
			border-radius: 16px;
			margin-top: 10px;
			display: flex;
			justify-content: space-between;
			gap: 20px;
			flex-wrap: wrap;
		}

		.card-section {
			flex: 1 1 45%;
			color: yellow;
		}

		.card h2 {
			margin: 0;
			font-size: 36px;
			color: white;
		}

		#digital-clock {
			font-size: 50px;
			font-weight: bold;
			color: white;
			line-height: 1.2;
			text-align: right;
			text-shadow: 0 0 0px white, 0 0 10px black, 0 0 10px #00ff99;
		}

		.prayer-list {
			display: flex;
			flex-wrap: wrap;
			gap: 12px;
			margin-top: 20px;
		}

		.prayer-item {
			background: #0e463a;
			display: flex;
			justify-content: space-between;
			align-items: center;
			padding: 12px 16px;
			border-radius: 12px;
			width: calc(50% - 6px);
			box-sizing: border-box;
			font-size: 16px;
		}

		.now-tag {
			background: #ffaa00;
			padding: 2px 8px;
			border-radius: 8px;
			color: black;
			font-size: 12px;
			margin-left: 8px;
		}

		.progress-section {
			margin-top: 30px;
		}

		.tabs {
			display: flex;
			justify-content: center;
			gap: 10px;
			margin-bottom: 10px;
		}

		.tabs button {
			background: #083e34;
			color: white;
			border: none;
			padding: 10px 20px;
			border-radius: 20px;
			cursor: pointer;
			font-size: 16px;
		}

		.tabs .active {
			background: white;
			color: #083e34;
			font-weight: bold;
		}

		.calendar {
			display: flex;
			flex-wrap: wrap;
			justify-content: flex-start;
		}

		.calendar-day {
			width: 13%;
			text-align: center;
			font-size: 14px;
			margin: 4px 0;
			cursor: pointer;
			padding: 6px 4px;
			border-radius: 10px;
		}

		.meta-row {
			display: flex;
			gap: 12px;
			align-items: center;
			margin-top: 8px;
			justify-content: flex-end;
			border-radius: 10px;
			/* Push items to the right */
		}


		.secondary {
			position: absolute;
/*
			margin-top: 3px;
			margin-left: 2px;
*/
			cursor: pointer;
		}



		#current-prayer {
			font-size: 42px;
			font-weight: bold;
			color: goldenrod;
			line-height: 1.2;
			text-align: left;
		}

		.calendar-day.active {
			background: white;
			color: black;
			font-weight: bold;
		}

		#weather {
			display: flex;
			gap: 8px;
			align-items: center;
			font-size: 15px;
		}

		#weather-icon {
			width: 36px;
			height: 36px;
			display: inline-block;
		}

		@media (max-width: 600px) {
			body {
				font-size: 16px;
			}

			.card-section {
				flex: 1 1 100%;
			}


		}

	</style>
</head>

<body>
	<div class="container">
		<div class="date-box">
			<div id="gregorian-date">Today</div> |
			<div id="hijri-date">Hijri Date</div>
		</div>

		<div class="location">
			<span id="location">üìç Getting location...</span> <span id="refresh-btn" class="btn secondary">‚ü≥</span>
			<div id="weather">
				<img id="weather-icon" src="" alt="" style="display:none" />
				<div id="weather-temp">--</div>
				<div id="weather-wind">--</div>
			</div>
		</div>

		<div class="card">
			<div class="card-section">
				<strong>Now</strong> <span id="mute-btn" class="btn">üîä</span>
				<div id="current-prayer">--</div>
			</div>


			<div class="card-section">
				<div id="digital-clock"></div>
			</div>
		</div>



		<div class="prayer-list" id="prayer-list"></div>

		<div class="progress-section">
			<div class="tabs">
				<button class="active" onclick="showWeek()">Week</button>
				<button onclick="showMonth()">Month</button>
			</div>
			<div class="calendar" id="calendar"></div>
		</div>
	</div>

	<!-- audio element: update src to your azan file name -->
	<audio id="azan-audio" src="azan.mp3" preload="auto"></audio>

	<script>
		/* Globals */
		let userCoords = null;
		let todayPrayerTimes = []; // { key, name, time (Date), timeStr24 }
		let azanPlayedFor = null; // key of prayer already played
		let isMuted = false;
		let selectedDateGlobal = new Date();
		const audio = document.getElementById('azan-audio');
		audio.muted = isMuted;

		// Unlock audio on first user click
		document.addEventListener('click', async () => {
			try {
				await audio.play();
				audio.pause();
				audio.currentTime = 0;
			} catch (e) {
				console.warn('Audio unlock failed', e);
			}
		});


		/* DOM helpers */
		const $ = id => document.getElementById(id);

		/* Digital clock */
		function updateDigitalClock() {
			const now = new Date();
			let hours = now.getHours();
			const minutes = now.getMinutes();
			const seconds = now.getSeconds();
			const ampm = hours >= 12 ? 'PM' : 'AM';
			hours = hours % 12 || 12;
			const timeStr = `${hours.toString().padStart(2,'0')}:${minutes.toString().padStart(2,'0')}:${seconds.toString().padStart(2,'0')}`;
			$('digital-clock').innerHTML = `${timeStr}<br><span style="font-size:0.45em">${ampm}</span>`;
		}
		setInterval(updateDigitalClock, 1000);
		updateDigitalClock();

		/* Toggle mute/unmute: attempt to unlock audio on unmute (user interaction) */
		$('mute-btn').addEventListener('click', async () => {
			isMuted = !isMuted;
			audio.muted = isMuted;
			$('mute-btn').textContent = isMuted ? 'üîá' : 'üîä';
			if (!isMuted) {
				try {
					await audio.play();
					audio.pause();
					audio.currentTime = 0;
				} catch (e) {
					/* won't break if autoplay blocked */
				}
			}
		});

		/* Refresh button */
		$('refresh-btn').addEventListener('click', () => {
			if (userCoords) {
				fetchPrayerTimes(selectedDateGlobal);
				fetchWeather(userCoords.latitude, userCoords.longitude);
				location.reload();
			}
		});

		/* Format time to 12h (HH:MM AM/PM), accepts "HH:MM" or "HH:MM:SS" */
		function formatTime12h(timeStr) {
			const parts = timeStr.split(':').map(Number);
			let h = parts[0],
				m = parts[1] ?? 0;
			const ampm = h >= 12 ? 'PM' : 'AM';
			h = h % 12 || 12;
			return `${h}:${String(m).padStart(2,'0')} ${ampm}`;
		}

		/* Utility to parse time string "HH:MM[:SS]" into Date on given date */
		function getTimeObj(timeStr, date = selectedDateGlobal) {
			const [h, m, s = '0'] = timeStr.split(':').map(Number);
			const t = new Date(date);
			t.setHours(Number(h), Number(m), Number(s || 0), 0);
			return t;
		}

		async function fetchWeather(lat, lon) {
			try {
				// Request temperature in Fahrenheit
				const url = `https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&current=temperature_2m,wind_speed_10m&temperature_unit=fahrenheit`;
				const res = await fetch(url);
				const data = await res.json();

				if (data && data.current) {
					const temp = data.current.temperature_2m;
					const wind = data.current.wind_speed_10m;
					$('weather-temp').textContent = `üå° ${temp}¬∞F`;
					$('weather-wind').textContent = `üí® ${wind} km/h`;
					$('weather-icon').style.display = 'none';
				} else {
					$('weather-temp').textContent = '--';
					$('weather-wind').textContent = '--';
					console.warn('Weather response missing current', data);
				}
			} catch (err) {
				console.error('fetchWeather error', err);
				$('weather-temp').textContent = '--';
				$('weather-wind').textContent = '--';
			}
		}

		/* Main: fetch prayer times from Aladhan & render */
		async function fetchPrayerTimes(selectedDate = new Date()) {
			if (!userCoords) return;
			selectedDateGlobal = selectedDate;
			// Reset todayPrayerTimes
			todayPrayerTimes = [];
			azanPlayedFor = null; // reset for new day/load

			const lat = userCoords.latitude;
			const lon = userCoords.longitude;
			const method = 2; // you can expose this
			const day = selectedDate.getDate();
			const month = selectedDate.getMonth() + 1;
			const year = selectedDate.getFullYear();

			const url = `https://api.aladhan.com/v1/calendar?latitude=${lat}&longitude=${lon}&method=${method}&month=${month}&year=${year}&school=1`;

			try {
				const res = await fetch(url);
				const json = await res.json();
				if (!json || json.code !== 200 || !json.data) throw new Error('Aladhan API error');
				const today = json.data[day - 1];
				const timings = today.timings;
				const hijri = today.date.hijri;
				const readable = today.date.readable;

				$('gregorian-date').textContent = `Today, ${readable}`;
				$('hijri-date').textContent = `${hijri.day} ${hijri.month.en} ${hijri.year}`;

				// prayer order (Ishraq derived)
				const prayerOrder = [{
						name: "Imsak üåô",
						key: "Imsak"
					},
					{
						name: "Fajr ‚ú®",
						key: "Fajr"
					},
					{
						name: "Sunrise üåÖ",
						key: "Sunrise"
					},
					{
						name: "Ishraq üåÑ",
						key: "Ishraq",
						derived: true,
						afterMinutes: 22
					},
					{
						name: "Dhuhr ‚òÄÔ∏è",
						key: "Dhuhr"
					},
					{
						name: "Asr ‚òÅÔ∏è",
						key: "Asr"
					},
					{
						name: "Maghrib üåá",
						key: "Maghrib"
					},
					{
						name: "Isha‚Äôa üåô",
						key: "Isha"
					}
				];

				// Render prayers
				const prayerList = $('prayer-list');
				prayerList.innerHTML = '';
				const now = new Date();
				const nowTime = new Date(now.getFullYear(), now.getMonth(), now.getDate(), now.getHours(), now.getMinutes(), now.getSeconds());
				let nextPrayer = null;
				let currentPrayer = null;

				for (const prayer of prayerOrder) {
					let timeStr24;
					if (prayer.derived && prayer.key === 'Ishraq') {
						// derived from Sunrise + afterMinutes
						const sunriseRaw = timings['Sunrise'].split(' ')[0]; // "HH:MM"
						const [sh, sm] = sunriseRaw.split(':').map(Number);
						const total = sh * 60 + sm + (prayer.afterMinutes || 15);
						const ih = Math.floor(total / 60) % 24;
						const im = total % 60;
						timeStr24 = `${String(ih).padStart(2,'0')}:${String(im).padStart(2,'0')}:00`;
					} else {
						if (!timings[prayer.key]) {
							// fallback: skip if no timing
							continue;
						}
						timeStr24 = timings[prayer.key].split(' ')[0];
						if (timeStr24.length === 5) timeStr24 += ':00';
					}

					const prayerTime = getTimeObj(timeStr24, selectedDate);
					todayPrayerTimes.push({
						key: prayer.key,
						name: prayer.name,
						time: prayerTime,
						timeStr24
					});

					if (nowTime < prayerTime && !nextPrayer) nextPrayer = {
						...prayer,
						time: prayerTime,
						timeStr24
					};
					if (nowTime >= prayerTime) currentPrayer = {
						...prayer,
						time: prayerTime,
						timeStr24
					};

					const isNow = currentPrayer && currentPrayer.key === prayer.key && (!nextPrayer || nowTime < nextPrayer.time);
					const item = document.createElement('div');
					item.className = 'prayer-item';
					item.innerHTML = `<div>${prayer.name}${isNow?'<span class="now-tag">Now</span>':''}</div><div>${formatTime12h(timeStr24)}</div>`;
					prayerList.appendChild(item);
				}

				$('current-prayer').innerHTML = currentPrayer ? `${currentPrayer.name}<br><span style="font-size:0.9em">${formatTime12h(currentPrayer.timeStr24)}</span>` : '--';

				// After we load prayer times also fetch weather (for same coords)
				fetchWeather(lat, lon);

			} catch (err) {
				console.error('fetchPrayerTimes error', err);
			}
		}

		/* Calendar UI */
		function showWeek() {
			switchTab('Week');
			const calendar = $('calendar');
			calendar.innerHTML = '';
			const now = new Date();
			const start = new Date(now);
			start.setDate(now.getDate() - now.getDay());
			for (let i = 0; i < 7; i++) {
				const date = new Date(start);
				date.setDate(start.getDate() + i);
				const isToday = date.toDateString() === (new Date()).toDateString();
				const el = document.createElement('div');
				el.className = `calendar-day ${isToday?'active':''}`;
				el.innerHTML = `${date.toLocaleDateString('en-US',{weekday:'short'})}<br>${date.getDate()}`;
				el.addEventListener('click', () => {
					fetchPrayerTimes(date);
					highlightActiveDay(el);
				});
				calendar.appendChild(el);
			}
		}

		function showMonth() {
			switchTab('Month');
			const calendar = $('calendar');
			calendar.innerHTML = '';
			const now = new Date();
			const year = now.getFullYear(),
				month = now.getMonth();
			const daysInMonth = new Date(year, month + 1, 0).getDate();
			const firstDay = new Date(year, month, 1).getDay();
			for (let i = 0; i < firstDay; i++) {
				const empty = document.createElement('div');
				empty.className = 'calendar-day';
				empty.innerHTML = '&nbsp;';
				calendar.appendChild(empty);
			}
			for (let d = 1; d <= daysInMonth; d++) {
				const date = new Date(year, month, d);
				const isToday = d === now.getDate();
				const el = document.createElement('div');
				el.className = `calendar-day ${isToday?'active':''}`;
				el.innerHTML = `${date.toLocaleDateString('en-US',{weekday:'short'})}<br>${d}`;
				el.addEventListener('click', () => {
					fetchPrayerTimes(date);
					highlightActiveDay(el);
				});
				calendar.appendChild(el);
			}
		}

		function highlightActiveDay(sel) {
			document.querySelectorAll('.calendar-day').forEach(e => e.classList.remove('active'));
			sel.classList.add('active');
		}

		function switchTab(tab) {
			document.querySelectorAll('.tabs button').forEach(btn => {
				btn.classList.remove('active');
				if (btn.textContent === tab) btn.classList.add('active');
			});
		}

		/* Interval: check every second to play azan (once per prayer) */
		setInterval(() => {
			if (!todayPrayerTimes.length) return;
			const now = new Date();
			for (const p of todayPrayerTimes) {
				const diff = now - p.time; // ms difference
				// Trigger Azan if it's the exact prayer time within the first 59 seconds
				if (diff >= 0 && diff < 59000 && azanPlayedFor !== p.key) {
					if (!isMuted) {
						audio.currentTime = 0;
						audio.play().catch(e => console.warn('Audio blocked:', e));
					}
					azanPlayedFor = p.key;
				}
			}
		}, 1000);


		/* Geolocation and Boot */
		navigator.geolocation.getCurrentPosition(async pos => {
			userCoords = pos.coords;
			// show textual location (reverse geocode)
			try {
				const r = await fetch(`https://nominatim.openstreetmap.org/reverse?format=jsonv2&lat=${userCoords.latitude}&lon=${userCoords.longitude}`);
				const j = await r.json();
				const place = j.address && (j.address.city || j.address.town || j.address.village || j.address.state) || '';
				$('location').textContent = `\u00A0\u00A0\u00A0\u00A0üìç${place || 'Your Location'}`;
			} catch (e) {
				$('location').textContent = '\u00A0\u00A0\u00A0\u00A0üìçLocation Unavailable';
			}
			// fetch weather and prayers
			fetchPrayerTimes(new Date());
		}, err => {
			console.error('Geolocation failed', err);
			$('location').textContent = 'üìç Location denied';
		});

		/* Unlock audio if user interacts with page (helps with autoplay policies) */
		document.addEventListener('click', async () => {
			try {
				await audio.play();
				audio.pause();
				audio.currentTime = 0;
			} catch (e) {}
		});

		/* initial calendar */
		showWeek();

		// Auto-refresh data every 60 seconds
		setInterval(() => {
			const now = new Date();
			if (userCoords) {
				fetchPrayerTimes(now);
				fetchWeather(userCoords.latitude, userCoords.longitude);
			}
		}, 60000);

	</script>
</body>

</html>
